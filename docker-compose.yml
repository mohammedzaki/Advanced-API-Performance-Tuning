version: '3.8'

services:
  jaeger:
    image: jaegertracing/all-in-one:latest
    container_name: jaeger
    ports:
      - "${JAEGER_UI_PORT:-16686}:16686" # Jaeger UI
      - "${JAEGER_COLLECTOR_PORT:-14250}:14250" # Collector endpoint for OTLP gRPC
    networks:
      - ${DOCKER_NETWORK:-perf-net}

  otel-collector:
    image: otel/opentelemetry-collector:latest
    command: ["--config=/etc/otel-collector-config.yaml"]
    volumes:
      - ./otel-collector-config.yaml:/etc/otel-collector-config.yaml:ro
    ports:
      - "${OTEL_COLLECTOR_GRPC_PORT:-4317}:4317"    # OTLP gRPC
      - "${OTEL_COLLECTOR_HTTP_PORT:-4318}:4318"    # OTLP HTTP
    networks:
      - ${DOCKER_NETWORK:-perf-net}

  spring-app:
    build:
      context: ./spring-boot-sample
    container_name: spring-app
    environment:
      - OTEL_EXPORTER_OTLP_ENDPOINT=${OTEL_EXPORTER_OTLP_ENDPOINT:-http://otel-collector:4318/v1/traces}
      - OTEL_SERVICE_NAME=${OTEL_SERVICE_NAME_SPRING:-spring-sample}
      - COURSE_FILE_URL=/mnt/data/Advanced_API_Performance_Tuning_20251105_123619_0000.docx
      - SPRING_PROFILES_ACTIVE=${SPRING_PROFILES_ACTIVE:-default}
      - SERVER_PORT=${SPRING_CONTAINER_PORT:-8080}
    ports:
      - "${SPRING_PORT:-8081}:${SPRING_CONTAINER_PORT:-8080}"
    depends_on:
      - otel-collector
    networks:
      - ${DOCKER_NETWORK:-perf-net}

  mssql:
    image: mcr.microsoft.com/mssql/server:2022-latest
    container_name: mssql
    environment:
      - ACCEPT_EULA=Y
      - SA_PASSWORD=${SQL_SERVER_PASSWORD:-YourStrong!Passw0rd}
      - MSSQL_PID=Developer
    ports:
      - "${SQL_SERVER_PORT:-1433}:1433"
    volumes:
      - mssql-data:/var/opt/mssql
      - ./db:/scripts
    healthcheck:
      test: ["CMD-SHELL", "/opt/mssql-tools18/bin/sqlcmd -S localhost -U sa -P 'YourStrong!Passw0rd' -Q 'SELECT 1' -C -b -o /dev/null"]
      interval: 10s
      timeout: 10s
      retries: 10
      start_period: 30s
    networks:
      - ${DOCKER_NETWORK:-perf-net}

  mssql-init:
    image: mcr.microsoft.com/mssql/server:2022-latest
    container_name: mssql-init
    depends_on:
      mssql:
        condition: service_healthy
    environment:
      - SA_PASSWORD=${SQL_SERVER_PASSWORD:-YourStrong!Passw0rd}
    volumes:
      - ./db:/scripts
    entrypoint: /bin/bash
    command: -c "/scripts/init-db.sh"
    networks:
      - ${DOCKER_NETWORK:-perf-net}

  dotnet-app:
    build:
      context: ./dotnet8-sample
    container_name: dotnet-app
    environment:
      - OTEL_EXPORTER_OTLP_ENDPOINT=${OTEL_EXPORTER_OTLP_ENDPOINT:-http://otel-collector:4318/v1/traces}
      - OTEL_SERVICE_NAME_DOTNET=${OTEL_SERVICE_NAME_DOTNET:-dotnet-sample}
      - COURSE_FILE_URL=/mnt/data/Advanced_API_Performance_Tuning_20251105_123619_0000.docx
      - ASPNETCORE_ENVIRONMENT=${ASPNETCORE_ENVIRONMENT:-Development}
      - SQL_SERVER_HOST=${SQL_SERVER_HOST:-mssql}
      - SQL_SERVER_PORT=${SQL_SERVER_PORT:-1433}
      - SQL_SERVER_DATABASE=${SQL_SERVER_DATABASE:-AdventureWorks2022}
      - SQL_SERVER_USER=${SQL_SERVER_USER:-sa}
      - SQL_SERVER_PASSWORD=${SQL_SERVER_PASSWORD:-YourStrong!Passw0rd}
      # Container internal ports
      - DOTNET_CONTAINER_HTTP_PORT=${DOTNET_CONTAINER_HTTP_PORT:-8081}
      - DOTNET_CONTAINER_GRPC_PORT=${DOTNET_CONTAINER_GRPC_PORT:-8083}
      # Report API configuration
      - REPORT_DEFAULT_MONTHS=${REPORT_DEFAULT_MONTHS:-3}
      - REPORT_DEFAULT_RECORDS=${REPORT_DEFAULT_RECORDS:-500}
      - REPORT_MAX_COMPLEXITY=${REPORT_MAX_COMPLEXITY:-10}
    ports:
      - "${DOTNET_GRPC_PORT:-8083}:${DOTNET_CONTAINER_GRPC_PORT:-8083}"  # gRPC service on HTTP/2
      - "${DOTNET_REST_PORT:-8081}:${DOTNET_CONTAINER_HTTP_PORT:-8081}"   # Rest service on HTTP/1.1
    depends_on:
      mssql:
        condition: service_healthy
      otel-collector:
        condition: service_started
    networks:
      - ${DOCKER_NETWORK:-perf-net}

  grpc-client-test:
    build:
      context: ./grpc-client-test
    container_name: grpc-client-test
    environment:
      - OTEL_EXPORTER_OTLP_ENDPOINT=${OTEL_EXPORTER_OTLP_ENDPOINT:-http://otel-collector:4318/v1/traces}
      - OTEL_SERVICE_NAME=${OTEL_SERVICE_NAME_GRPC_CLIENT:-grpc-client-test}
      - ASPNETCORE_ENVIRONMENT=${ASPNETCORE_ENVIRONMENT:-Development}
      - GRPC_ENABLE_REFLECTION=${GRPC_ENABLE_REFLECTION:-true}
      - GRPC_ENABLE_DETAILED_ERRORS=${GRPC_ENABLE_DETAILED_ERRORS:-true}
    ports:
      - "${GRPC_CLIENT_TEST_PORT:-8084}:8083"  # gRPC client test API
    depends_on:
      - otel-collector
      - dotnet-app
    networks:
      - ${DOCKER_NETWORK:-perf-net}

  k6:
    image: grafana/k6:latest
    container_name: k6
    environment:
      - BASE_URL=${K6_BASE_URL:-http://dotnet-app:8081}
      - VUS=${K6_CONCURRENT_USERS:-10}
      - DURATION=${K6_DURATION:-30s}
    volumes:
      - ./k6:/k6
    entrypoint: ["k6", "run", "/k6/baseline.js"]
    depends_on:
      - spring-app
      - dotnet-app
    networks:
      - ${DOCKER_NETWORK:-perf-net}

  prometheus:
    image: prom/prometheus:latest
    container_name: prometheus
    volumes:
      - ./prometheus.yml:/etc/prometheus/prometheus.yml:ro
    ports:
      - "${PROMETHEUS_PORT:-9090}:9090"
    networks:
      - ${DOCKER_NETWORK:-perf-net}

  grafana:
    image: grafana/grafana:latest
    container_name: grafana
    ports:
      - "${GRAFANA_PORT:-3000}:3000"
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=admin
    depends_on:
      - prometheus
    networks:
      - ${DOCKER_NETWORK:-perf-net}

  react-dashboard:
    build:
      context: ./react-reports-dashboard
    container_name: react-dashboard
    environment:
      - REACT_APP_API_URL=${REACT_APP_API_URL:-http://localhost:8081}
    ports:
      - "3001:80"  # React dashboard on port 3001
    depends_on:
      - dotnet-app
    networks:
      - ${DOCKER_NETWORK:-perf-net}

volumes:
  mssql-data:
    driver: local

networks:
  perf-net:
    driver: bridge
